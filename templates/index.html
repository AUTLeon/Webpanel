<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Server Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Minecraft Server Panel</h1>
    {% for key, server in servers.items() %}
    <div class="server-card" id="{{ key }}">
        <h2>Server {{ server.name }}</h2>
        <p>Status: <span class="status">Unbekannt</span></p>
        <div class="buttons">
            <button onclick="startServer('{{ key }}')">Start</button>
            <button onclick="stopServer('{{ key }}')">Stop</button>
            <button onclick="restartServer('{{ key }}')">Restart</button>
            <button onclick="backupServer('{{ key }}')">Backup</button>
        </div>
        <div class="console">
            <h3>Console</h3>
            <pre class="logs"></pre>
            <input type="text" placeholder="Befehl eingeben..." onkeydown="if(event.key==='Enter') sendCommand('{{ key }}', this.value); this.value='';">
        </div>
    </div>
    {% endfor %}

<script>
function updateStatus(server){
    fetch(`/${server}/status`)
    .then(res => res.json())
    .then(data => {
        document.querySelector(`#${server} .status`).innerText = data.running ? '✅ läuft' : '❌ gestoppt';
    });
}

function startServer(server){
    fetch(`/${server}/start`).then(r=>r.json()).then(updateStatus(server));
}
function stopServer(server){
    fetch(`/${server}/stop`).then(r=>r.json()).then(updateStatus(server));
}
function restartServer(server){
    fetch(`/${server}/restart`).then(r=>r.json()).then(updateStatus(server));
}
function backupServer(server){
    fetch(`/${server}/backup`).then(r=>r.json()).then(res=>alert(res.output || res.error));
}

function sendCommand(server, cmd){
    fetch(`/${server}/console`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({command: cmd})
    }).then(r=>r.json()).then(res=>{
        if(res.status!=='success') alert(res.msg);
    });
}

function fetchLogs(){
    {% for key, server in servers.items() %}
    fetch(`/{{ key }}/logs`).then(r=>r.text()).then(text=>{
        let logEl = document.querySelector('#{{ key }} .logs');
        logEl.innerText = text;
        logEl.scrollTop = logEl.scrollHeight;
    });
    {% endfor %}
}

// Refresh Status & Logs alle 2 Sekunden
setInterval(()=>{
    {% for key in servers.keys() %}
    updateStatus('{{ key }}');
    {% endfor %}
    fetchLogs();
}, 2000);

// Initial Update
{% for key in servers.keys() %}
updateStatus('{{ key }}');
{% endfor %}
</script>
</body>
</html>
