<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Minecraft Multiserver Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Logs style with word-wrap and smooth scrolling */
        .logs {
            background: rgba(30,30,30,0.8);
            color: #eee;
            padding: 12px;
            border-radius: 10px;
            text-align: left;
            overflow-y: auto;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
            max-height: 300px;
            font-family: monospace;

            white-space: pre-wrap;   /* wrap long lines */
            word-break: break-word;   /* clean line breaks */
            scroll-behavior: smooth; /* smooth scrolling */
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <h1>Minecraft Multiserver Panel</h1>

        <!-- Server selection -->
        <div class="server-switch">
            <button class="switch-btn" data-server="server1">Server 1 (1.21.10)</button>
            <button class="switch-btn" data-server="server2">Server 2 (1.20.4)</button>
        </div>

        <!-- Panels -->
        <div id="server1-panel" class="server-panel">
            <h2>Server 1 â€“ 1.21.10</h2>
            <div class="meta">
                Active Screen: <strong id="screen-name-1">loading...</strong>
            </div>
            <div class="buttons">
                <button class="start" onclick="serverAction('server1', 'start')">ðŸš€ Start</button>
                <button class="stop" onclick="serverAction('server1', 'stop')">ðŸ›‘ Stop</button>
                <button class="backup" onclick="serverAction('server1', 'backup')">ðŸ’¾ Backup</button>
            </div>
            <div class="status">
                Status: <span id="status-text-1">loading...</span>
            </div>
            <pre id="logs-1" class="logs">loading logs...</pre>
            <div class="console-input">
                <input id="console-command-1" class="console-input-text" type="text" placeholder="Enter command...">
                <button onclick="sendConsoleCommand('server1')">Send</button>
            </div>
        </div>

        <div id="server2-panel" class="server-panel" style="display:none;">
            <h2>Server 2 â€“ 1.20.4</h2>
            <div class="meta">
                Active Screen: <strong id="screen-name-2">loading...</strong>
            </div>
            <div class="buttons">
                <button class="start" onclick="serverAction('server2', 'start')">ðŸš€ Start</button>
                <button class="stop" onclick="serverAction('server2', 'stop')">ðŸ›‘ Stop</button>
                <button class="backup" onclick="serverAction('server2', 'backup')">ðŸ’¾ Backup</button>
            </div>
            <div class="status">
                Status: <span id="status-text-2">loading...</span>
            </div>
            <pre id="logs-2" class="logs">loading logs...</pre>
            <div class="console-input">
                <input id="console-command-2" class="console-input-text" type="text" placeholder="Enter command...">
                <button onclick="sendConsoleCommand('server2')">Send</button>
            </div>
        </div>
    </div>

<script>
const serverMap = { server1: 1, server2: 2 };

/* ===== Switch Server ===== */
document.querySelectorAll(".switch-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const server = btn.dataset.server;
        document.querySelectorAll(".server-panel").forEach(p => p.style.display = "none");
        document.getElementById(server + "-panel").style.display = "block";
        loadLogs(server);
        updateStatus(server);
    });
});

/* ===== STATUS ===== */
async function updateStatus(server){
    const idx = serverMap[server];
    const sText = document.getElementById("status-text-" + idx);
    const screenName = document.getElementById("screen-name-" + idx);
    try{
        const resp = await fetch(`/${server}/status`);
        const j = await resp.json();
        if(j.running){
            sText.innerText = "running";
            sText.style.color = "#4caf50";
        } else {
            sText.innerText = "stopped";
            sText.style.color = "#f44336";
        }
        screenName.innerText = j.detected_screen || "none detected";
    } catch(e){
        sText.innerText = "Error!";
        sText.style.color = "#ff9800";
        screenName.innerText = "Error";
    }
}

/* ===== START/STOP/BACKUP ===== */
async function serverAction(server, action){
    const idx = serverMap[server];
    const sText = document.getElementById("status-text-" + idx);
    try{
        const resp = await fetch(`/${server}/${action}`);
        const txt = await resp.text();
        sText.innerText = txt;
        sText.style.color = "#f0a500";
        setTimeout(()=>updateStatus(server),1500);
        setTimeout(()=>loadLogs(server),2000);
    } catch(e){
        sText.innerText = "Error!";
    }
}

/* ===== LOGS with Auto-Scroll & Word Wrap ===== */
async function loadLogs(server){
    const idx = serverMap[server];
    const logsBox = document.getElementById(`logs-${idx}`);
    try{
        const resp = await fetch(`/${server}/logs`);
        if(resp.status === 200){
            logsBox.innerText = await resp.text();
            logsBox.scrollTop = logsBox.scrollHeight; // Auto scroll
        } else {
            logsBox.innerText = "Error: " + await resp.text();
        }
    } catch(e){
        logsBox.innerText = "Error loading logs";
    }
}

/* ===== CONSOLE ===== */
async function sendConsoleCommand(server){
    const idx = serverMap[server];
    const cmdInput = document.getElementById(`console-command-${idx}`);
    const cmd = cmdInput.value.trim();
    if(!cmd) return;
    const logsBox = document.getElementById(`logs-${idx}`);
    const resp = await fetch(`/${server}/console`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({command:cmd})
    });
    const txt = await resp.text();
    logsBox.innerText += `\n> ${cmd}\n${txt}\n`;
    logsBox.scrollTop = logsBox.scrollHeight; // Auto scroll
    cmdInput.value = "";
}

/* ===== Press Enter ===== */
document.querySelectorAll("input[id^='console-command-']").forEach(input => {
    input.addEventListener("keypress", e => {
        if(e.key==="Enter"){
            const server = input.id.includes("1")?"server1":"server2";
            sendConsoleCommand(server);
        }
    });
});

/* ===== Initial load ===== */
Object.keys(serverMap).forEach(s => { 
    updateStatus(s); 
    loadLogs(s); 
});
setInterval(()=>Object.keys(serverMap).forEach(s => updateStatus(s)),5000);
setInterval(()=>Object.keys(serverMap).forEach(s => loadLogs(s)),2000); // automatic logs every 2s
</script>
</body>
</html>
